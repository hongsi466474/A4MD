- 渲染公式：
```math
L(\omega_{o})=\int_{\Omega}L_{i}(\omega_{i})f(\omega_{i},\omega_{o})(\omega_{i}\cdot n)\mathrm{d}\omega_{i} \tag{4}
```

>- $`L(\omega _o)`$ 与 $`L(\omega _i)`$ 分别表示 $`\omega _o`$ 方向的出射光线和 $`\omega _i`$ 方向的入射光线
>- $`f(\omega _{i},\omega _{o})`$ 是点的 BRDF 特性，可用迪斯尼着色模型确定：

>```math
>f(\omega_i),\omega_o)=\frac{k_{d}}{\pi}+\frac{DFG}{4(\omega_{i}\cdot n)(\omega_{o}\cdot n)} \tag{5}
>```

>	- $D$ ：正态分布函数
>	- $F$ ：菲涅尔项
>	- $G$ ：几何项
>	- 这三项的计算详见 [5.1](https://zhuanlan.zhihu.com/p/443873239)

- 用 $`6\times512\times512`$ High Dynamic Range (HDR) cube map 模拟场景的环境光照
- 用 SplitSum ([2.2.4.1](https://zhuanlan.zhihu.com/p/121719442)) 近似法分离光照和 BRDF 积分，以实现高效阴影计算
- 最终着色：$`c _g=c _{dif}+c _{spec}`$ 
-	- 漫反射颜色 ：

```math
c_{dif}=\frac{k _{d}}{\pi}\int _{\Omega}L _{i}(\omega _{i})(\omega _{i}\cdot n)\mathrm{d}\omega _{i} \tag{6}
```

>- $`L _{i}(\omega _{i})(\omega _{i}\cdot n)`$ 只依赖于法向 $`n`$ ，并且可以被预计算并存储在 2D 纹理
- - 镜面反射颜色：

```math
\begin{align}
c_{spec} & \approx Int_{light}\cdot Int_{BRDF} \\
& =\int_{\Omega}L_{i}(\omega_{i})D(\omega_{i},\omega_{o})(\omega_{i}\cdot n)\mathrm{d}\omega_{i}\cdot \int_{\Omega}f(\omega_{i},\omega_{o})(\omega_{i}\cdot n)\mathrm{d}\omega_{i} \tag{7}
\end{align}
```

>- $`Int _{light}`$ 表示入射光与正态分布函数 $D$ 的积分
>- - 对于给定的环境贴图， $`Int _{light}`$ 只与粗糙值 $`r`$ 有关
>- - 故可以预计算并存在 mipmap 中（每一个 mip level 对应一个固定的粗糙值）
>- $`Int _{BRDF}`$ 是均匀白色环境光照下镜面 BRDF 的积分
>- - 由 BRDF 中的粗糙值和入射光方向与法向之间的点积 $`\omega _i\cdot n`$ 决定
>- - 也可预计算并存在 2D 纹理中，在渲染时进行有效查询
